

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Jiacheng Xie">
  <meta name="keywords" content="">
  
    <meta name="description" content="SQL Server 2012 实施与管理实战指南读书笔记，高可用性和灾难恢复技术">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL Server 2012 实施与管理实战指南Note：高可用性和灾难恢复技术">
<meta property="og:url" content="http://example.com/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/index.html">
<meta property="og:site_name" content="Ycheng&#39;s Blog">
<meta property="og:description" content="SQL Server 2012 实施与管理实战指南读书笔记，高可用性和灾难恢复技术">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/SQL%20Server.png">
<meta property="article:published_time" content="2022-07-17T14:50:22.000Z">
<meta property="article:modified_time" content="2022-08-17T11:24:46.898Z">
<meta property="article:author" content="Jiacheng Xie">
<meta property="article:tag" content="SQL Server">
<meta property="article:tag" content="Note">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/SQL%20Server.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>SQL Server 2012 实施与管理实战指南Note：高可用性和灾难恢复技术 - Ycheng&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.1","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>YCheng&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SQL Server 2012 实施与管理实战指南Note：高可用性和灾难恢复技术"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-17 22:50" pubdate>
          July 17, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.6k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          39 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SQL Server 2012 实施与管理实战指南Note：高可用性和灾难恢复技术</h1>
            
            <div class="markdown-body">
              
              <h1
id="sql-server-2012-实施与管理实战指南note高可用性和灾难恢复技术">SQL
Server 2012 实施与管理实战指南Note：高可用性和灾难恢复技术</h1>
<p>SQL Server
“高可用性”和“灾难恢复”四个传统技术：故障转移群集(Cluster)、日志传送(Log
Shipping)、复制(Replication)和数据库镜像(database Mirroring)</p>
<h2 id="高可用性与灾难恢复">“高可用性”与“灾难恢复”</h2>
<p>数据库服务的可用时间=在线时间/（在线时间+宕机时间）</p>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608130753104-16546649635641.png" srcset="/img/loading.gif" lazyload
alt="数据库服务的可用时间" />
<figcaption aria-hidden="true">数据库服务的可用时间</figcaption>
</figure>
<p>SQL Server服务由两部分组成：</p>
<ol type="1">
<li>SQL Server作为应用服务，由Windows上的可执行文件提供功能。</li>
<li>储存在硬盘上的数据。</li>
</ol>
<p>“高可用性”（High
Availability，简称HA）指的是数据库服务能够始终保持在线运行，针对的是软件或硬件问题造成的数据库系统不可用。</p>
<p>“灾难恢复”（Disaster
Recovery，简称DR）指的是当数据库中的数据发生损坏或者不可访问时，可以在尽可能短的时间恢复全部数据或者恢复尽可能多的数据，从而保证应用系统的正常运行，针对的是保存在数据库系统中的数据不可用。</p>
<h2 id="sql-server故障转移群集">SQL Server故障转移群集</h2>
<p><em>SQL
Server故障转移群集</em>是一项基于<em>Windows故障转移群集</em>的一种技术。</p>
<h3 id="windows故障转移群集">Windows故障转移群集</h3>
<h4 id="结构">结构</h4>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608131602446.png" srcset="/img/loading.gif" lazyload
alt="故障转移群集的结构" />
<figcaption aria-hidden="true">故障转移群集的结构</figcaption>
</figure>
<ol type="1">
<li>Windows故障转移群集由多个服务器（Node）组成，每个Node都运行着Microsoft集群服务（MSCS）</li>
<li>共享磁盘（Shared Array）：存放需要共享的数据，如SQL
Server的数据库文件、错误日志等</li>
<li>本地磁盘（Drive
C）：每个节点的本地磁盘，存放不需要共享的内容。当某节点是活跃节点时，用户可以访问其本地磁盘而不能访问其他Node的本地磁盘。</li>
<li>私有网络（Private
Network）：由每个Node上的私有网卡相互连接形成，用于“心脏线”信号，即节点相互感知彼此是否正常工作，如某节点无法回应信号，即被排出群集。</li>
<li>公用网络（Public
Network）：外部资源通过节点上的公共网卡访问该节点。</li>
<li>混合网络（Mixed
Network）：由于私有网卡和公共网卡在物理上可以是一块网卡，群集可以通过一个网络完成私有和公共网络的功能。</li>
<li>虚拟服务器（Virtual
Server）：由群集内所有节点组成的一个（虚拟）服务器。有与群集内任何节点都不同的IP地址（虚拟IP）和机器名（虚拟网络名）。虚拟IP一定要和公共网络配置在同一个网段里。</li>
<li>资源：指在Windows群集中，虚拟IP，虚拟网络名，共享磁盘，SQL
Server等等。在任意时刻，只有群集中的一个节点（活跃节点，用户实际登录的节点）能提供用户所需的服务和资源，而其他节点都处于空闲状态。</li>
<li>活跃节点：当前拥有该群集资源的节点，由Windows群集服务决定。</li>
<li>客户端的连接指令始终都是一样的：指向虚拟IP，或者虚拟网络名，对虚拟服务器的请求会被转向到活跃节点上。</li>
</ol>
<h4 id="故障转移failover">故障转移（Failover）</h4>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608134016918.png" srcset="/img/loading.gif" lazyload
alt="资源的故障转移" />
<figcaption aria-hidden="true">资源的故障转移</figcaption>
</figure>
<p>当前拥有资源的节点NodeA出现故障时，Windows群集会自动发起故障转移，转移后NodeB拥有资源。</p>
<p>故障转移发生：</p>
<ol type="1">
<li>由于故障自动切换</li>
<li>系统管理员手动切换</li>
</ol>
<h3 id="sql-server故障转移群集-1">SQL Server故障转移群集</h3>
<p>SQL Server故障转移群集，即将SQL
Server部署在Windows群集中的多个节点上以组成一个虚拟SQL
Server实例。在当前活跃节点不可用时，SQL
Server可以被切换到工作正常的节点上继续进行服务。</p>
<h4 id="sql-server群集资源组的结构">SQL Server群集资源组的结构</h4>
<p>“资源组”是由一个或者多个（相互关联）的资源组成的组，在任何时候每个资源组都仅属于其“活跃节点”，所有的故障转移都是以资源组为单位发生。</p>
<p>对于SQL Server资源组，通常包含以下资源：</p>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608144213186.png" srcset="/img/loading.gif" lazyload
alt="故障转移群集管理器中查看SQL Server资源组的拥有者" />
<figcaption aria-hidden="true">故障转移群集管理器中查看SQL
Server资源组的拥有者</figcaption>
</figure>
<h5 id="sql-server网络名和sql-server-ip地址">SQL Server网络名和SQL
Server IP地址</h5>
<p>SQL Server实例拥有专属的虚拟网络名和IP地址，它们提供了应用程序访问SQL
Server时使用的机器名或者IP地址。SQL
Server群集并不使用Windows群集的虚拟网络名和虚拟IP地址来作为应用程序访问它的接口。</p>
<h5 id="sql-server和sql-server-agent">SQL Server和SQL Server Agent</h5>
<p>SQL Server群集中所有节点都安装有SQL Server和SQL Server
Agent服务以及与服务所对应的二进制文件、注册表键值等。</p>
<p>在群集正常运行的情况下，只有活跃节点的SQL
Server实例是Running的，其他节点上都是Stopped。</p>
<p>SQL Server资源名：</p>
<ol type="1">
<li>SQL Server是默认实例，资源名为SQL Sever</li>
<li>SQL Server是命名实例，资源名为SQL Server（实例名），eg “SQL Server
(MSSQLSERVER)”</li>
</ol>
<p>客户端程序通过“虚拟网络名”访问SQL Server实例。</p>
<h5 id="共享磁盘">共享磁盘</h5>
<p>共享磁盘资源可以是一块<em>逻辑磁盘</em>，也可以是一块磁盘上的一个<em>mount
point</em>。</p>
<p>共享磁盘保存SQL Server群集实例的：</p>
<ol type="1">
<li>数据库的所有数据文件和事务日志文件（MDF，NDF和LDF）</li>
<li>SQL Server和SQL Server Agent的日志文件（ERRORLOG）</li>
<li>其他的文件和目录</li>
</ol>
<p>共享磁盘和SQL Server必须在用一资源组里，SQL
Server依赖于共享磁盘。</p>
<p>一个共享磁盘资源只能属于一个SQL Server实例，但是一个SQL
Server群集实例可以使用多个共享磁盘。</p>
<h5 id="其他">其他</h5>
<p>可能包含：</p>
<ol type="1">
<li>File Share资源：如果 SQL Server要使用FileStream</li>
<li>Analysis Services资源</li>
</ol>
<h5 id="资源状态">资源状态</h5>
<p><strong>上线（online）：</strong>该资源在某个节点上正常工作中。</p>
<p><strong>离线（offline）：</strong>该资源在某个节点上处于停止工作状态，无法提供相应的服务。</p>
<p><strong>失败（failed）：</strong>该资源在某节点尝试上线，但是由于某些异常无法上线成功。</p>
<p><strong>上线挂起（online
pending）：</strong>资源尝试进入上线状态，但是还没完全成功上线。</p>
<p><strong>离线挂起（offline
pending）：</strong>资源尝试进入离线状态，但是还没完全成功离线。</p>
<h4 id="集群资源的配置">集群资源的配置</h4>
<p>在 <strong>Properties</strong>中，我们可以对于群集资源进行设置：</p>
<h5 id="dependencies">Dependencies</h5>
<p>一个资源所依赖的其他资源必须要和这个资源处于<u>同一个资源组</u>里，跨资源组的依赖关系是不存在的</p>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608151524630.png" srcset="/img/loading.gif" lazyload
alt="Dependencies选择卡" />
<figcaption aria-hidden="true">Dependencies选择卡</figcaption>
</figure>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608151633015.png" srcset="/img/loading.gif" lazyload
alt="SQL Server资源组中属性的依赖关系" />
<figcaption aria-hidden="true">SQL
Server资源组中属性的依赖关系</figcaption>
</figure>
<h5 id="policies">Policies</h5>
<p>Policies决定了该资源发生故障转移时的行为。</p>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608151828624.png" srcset="/img/loading.gif" lazyload
alt="Policies选择卡" />
<figcaption aria-hidden="true">Policies选择卡</figcaption>
</figure>
<p>Affect the Group设置：</p>
<ul class="task-list">
<li><input type="checkbox" disabled="" checked="" />
If resource fails, attempt restart on current node</li>
<li><input type="checkbox" disabled="" checked="" />
If restart is unsuccessful, fail over all resources in this service or
application</li>
</ul>
<p>​ 适用于：SQL
Server资源，共享磁盘资源，虚拟IP地址资源，虚拟服务名资源</p>
<p>Not affect the Group设置：</p>
<ul class="task-list">
<li><input type="checkbox" disabled="" checked="" />
If resource fails, attempt restart on current node</li>
<li><input type="checkbox" disabled="" />
If restart is unsuccessful, fail over all resources in this service or
application</li>
</ul>
<p>​ 适用于：（出于最大化高可用目的，消除不必要的Failover）SQL Server
Agent资源，Fill Share资源，Analysis Services资源</p>
<h5 id="advanced-policies">Advanced Policies</h5>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608152531006.png" srcset="/img/loading.gif" lazyload
alt="Advanced Policies选择卡" />
<figcaption aria-hidden="true">Advanced Policies选择卡</figcaption>
</figure>
<p><code>Basic resource health check interval</code>和<code>Thorough resource health check interval</code>是Windows
Cluster在不同时间间隔做的两种不同程度的检查（Looks alive check，Is alive
check），用于确认每个资源是否在正常工作。</p>
<h3 id="sql-server群集什么时候会发生故障转移">SQL
Server群集什么时候会发生“故障转移”</h3>
<p>当Looks alive check或Is alive
check检查失败时，进行故障转移。由于故障转移一般是意外发生的，所以SQL
Server切换到新节点以后，还需要一段时间来做数据库的recovery。</p>
<p>群集里的每个资源都是一种资源类型。根据不同类型的资源，会使用不同的方式进行isalive和looksalive检查。
| 资源 | 资源类型 | | ---------- | ------------ | | 共享磁盘 |
physicaldisk | | 虚拟IP | IP Address | | SQL Server | SQL Server |</p>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/clip_image002.png" srcset="/img/loading.gif" lazyload
alt="资源类型、资源DLL和资源的关系" />
<figcaption
aria-hidden="true">资源类型、资源DLL和资源的关系</figcaption>
</figure>
<p>Windows群集服务进程clussvc.exe会产生名为RHS.exe的进程，RHS.exe会装载resource
dll，并且调用dll中定义的方法来检查相应resource的状态。一个资源其属性的Advanced
Polices选项卡中如果没有勾选“run this resource in a separate Resource
”，它的resource
dll就会装载在一个默认的RHS.exe中；反之，则会有一个单独的RHS.exe来装载该资源的resource
dll。所以在任务管理器中你可能看到多个RHS.exe进程。</p>
<figure>
<img
src="/2022/07/17/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%8A%80%E6%9C%AF/image-20220608162438129.png" srcset="/img/loading.gif" lazyload
alt="多个RHS.exe进程" />
<figcaption aria-hidden="true">多个RHS.exe进程</figcaption>
</figure>
<p>Windows群集自带的资源类型：</p>
<ol type="1">
<li>physical disk, IP, network name和DTC等</li>
<li>检查的方法定义在resource DLL，<code>clusres.dll</code>中</li>
</ol>
<p>非Windows群集自带的资源类型：</p>
<ol type="1">
<li><p>SQL Server</p></li>
<li><p>如有专属资源类型和专属resource dll，在resource
dll中定义检查方法</p>
<blockquote>
<p>SQL ServerD的resource dll：</p>
<p>SQL Server资源（通常affect the group模式）
--&gt;<code>sqsrvres.dll</code></p>
<p>​ Looksalive：默认5秒一次，通过服务控制管理器（Service Control
Manager，简称SCM）检查SQL Server服务在活跃节点是否处于“启动状态”</p>
<p>​
Isalive：默认60秒一次，如lookalive检查的结果失败，立刻触发Isalive检查。SQL
2012之前，通过连 接SQL
Server群集实例并获取运行命令的返回结果来进行判断。如果连接不上SQL
Server群集实例或
者语句运行失败，那么Isalive检查失败。此时Windows群集会再做3-5次（根据Windows的版本和设置
不同）Isalive检查。如最终检查失败，则进行故障转移。</p>
<p>SQL Server Agent资源--&gt;<code>sqagtres.dll</code></p>
</blockquote></li>
</ol>
<p>”通用服务“（Generic Service）资源类型：</p>
<ol type="1">
<li>Analysis Service</li>
<li>使用<code>clusres.dll</code>来作为resource
dll并沿用定义进行检查。</li>
</ol>
<p>Cluster-aware服务：</p>
<ol type="1">
<li>可以通过resource dll形成群集资源</li>
<li>SQL Server、SQL Server Agent，Analysis Service服务</li>
</ol>
<p>非Cluster-aware服务：</p>
<ol type="1">
<li>无法通过任何resource
dll在Windows群集中形成资源，即使安装在群集的节点上也会被视作安装在单机环境，无法故障转移。</li>
<li>SQL browser, Reporting Service等</li>
<li>Integration
Services不是Cluster-aware，可以人为配置为群集资源（不推荐），但是不具有自动故障转移功能。</li>
</ol>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/SQL-Server/">#SQL Server</a>
      
        <a href="/tags/Note/">#Note</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SQL Server 2012 实施与管理实战指南Note：高可用性和灾难恢复技术</div>
      <div>http://example.com/2022/07/17/SQL Server 2012 实施与管理实战指南Note：高可用性和灾难恢复技术/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Jiacheng Xie</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>July 17, 2022</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="SA - Share-alike">
                <i class="iconfont icon-sa"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/29/SQL%20Server%202012%20%E5%AE%9E%E6%96%BD%E4%B8%8E%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97Note%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/" title="SQL Server 2012 实施与管理实战指南Note：数据库备份与恢复">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SQL Server 2012 实施与管理实战指南Note：数据库备份与恢复</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/10/SQL%20Server%202012%20Internal%20Note_Logging%20and%20recovery/" title="SQL Server 2012 Internal Note_Logging and recovery">
                        <span class="hidden-mobile">SQL Server 2012 Internal Note_Logging and recovery</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i> Ycheng 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Totoal views 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Total visitors 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
